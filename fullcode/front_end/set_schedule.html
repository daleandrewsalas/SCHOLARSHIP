<?php
session_start();
// Check if admin is logged in
if (!isset($_SESSION["logged_in"]) || $_SESSION["logged_in"] !== true) {
    // Redirect to admin login page if not logged in
    header("Location: login_admin.php");
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduGrants - Set Schedule</title>

    <!-- MAIN DASHBOARD CSS -->
    <link rel="stylesheet" href="../css/Admin_Dashboard.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
<div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand">
            <img src="../icon/logo.png" class="logo">
            <div class="brand-text">EduGrants</div>
        </div>

        <nav class="nav">
            <a href="admin_dashboard.html" class="nav-item"><img src="../icon/dashboard.png" class="ico"> Dashboard</a>
            
            <a href="admin_profile.html" class="nav-item"><img src="../icon/admin.png" class="ico"> Admin Profile</a>

            <div class="nav-item dropdown">
                <button class="dropdown-btn">
                    <img src="../icon/apply.png" class="ico"> Student Registration
                    <span class="arrow">▸</span>
                </button>

                <div class="dropdown-content">
                    <a href="system_account.html" class="nav-item"><img src="../icon/account.png" class="ico"> System Account</a>
                    <a href="pending_accounts.html">Pending Applications</a>
                </div>
            </div>

            <a href="set_schedule.html" class="nav-item"><img src="../icon/schedule.png" class="ico"> Set Schedule</a>
            <a href="login_admin.php" class="nav-item"><img src="../icon/logout.png" class="ico"> Log out</a>
        </nav>

        <div class="sidebar-footer">
            <small>v1.0 • Prototype</small>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

        <!-- TOPBAR -->
        <header class="topbar">
            <div class="top-actions">

                <!-- NOTIFICATION -->
                <div class="notif-wrapper">
                    <button class="notif-btn" id="notifBtn">
                        <img src="../icon/notification.png" class="notif-icon">
                        <span class="notif-badge" style="display:none;"></span>
                    </button>

                    <div class="notif-dropdown" id="notifDropdown" style="display:none;">
                        <div class="notif-header">Notifications</div>
                        <ul class="notif-list" id="notifList"></ul>
                    </div>
                </div>

                <div class="admin">
                    <img class="avatar" src="../icon/user.png" alt="avatar">
                    <span class="admin-name" id="adminName">Admin</span>
                </div>

            </div>
        </header>

        <!-- MAIN CONTENT -->
                <section class="content">

            <h2 class="page-title">SET SCHEDULE</h2>

            <div class="ap-actions-row">
                <button class="add-btn ap-add-btn" id="openAddForm">Select Schedule</button>
            </div>

            <div class="section-title">Submission of Requirements</div>

            <div class="accounts-container">

                <table class="adminTable" id="scheduleTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Slots</th>
                            <th>Remaining Slots</th>
                        </tr>
                    </thead>

                    <tbody id="scheduleTableBody">
                        <tr class="empty-row">
                            <td colspan="3" style="text-align:center; color:#444; padding:35px;">
                                No schedules yet — click <b>Select Schedule</b> to add one.
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>

        </section>
    </main>
</div>

<!-- MODAL -->
<div class="modal" id="scheduleModal">
    <div class="modal-content">
        <h3>Add Schedule</h3>

                <form id="scheduleForm" action="../backend/save_schedule.php" method="POST">
                    <label for="schedule_date">Schedule Date:</label>
                    <input type="date" id="schedule_date" name="schedule_date" required>

                    <label for="total_slots">Total Slots:</label>
                    <input type="number" id="total_slots" name="total_slots" min="1" required>

                    <div class="modal-actions">
                        <button type="submit" class="btn-primary">Save</button>
                        <button type="button" class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                    </div>
                </form>
    </div>
</div>

<script>
function openScheduleModal() {
    document.getElementById("scheduleModal").style.display = "flex";
}

function closeScheduleModal() {
    document.getElementById("scheduleModal").style.display = "none";
}

document.getElementById("notifBtn").addEventListener("click", () => {
    const box = document.getElementById("notifDropdown");
    box.style.display = box.style.display === "block" ? "none" : "block";
});

// Sidebar dropdown toggle (same behavior as other pages)
document.querySelectorAll(".nav-item.dropdown").forEach(dropdownItem => {
    const btn = dropdownItem.querySelector(".dropdown-btn");
    if (btn) {
        btn.addEventListener('click', () => {
            dropdownItem.classList.toggle('active');
        });
    }
});

// Hook the Select Schedule button to open the modal
const openBtn = document.getElementById('openAddForm');
if (openBtn) openBtn.addEventListener('click', openScheduleModal);

// AJAX form submit so UI updates immediately and is ready for user panel integration
const scheduleForm = document.getElementById('scheduleForm');
const scheduleTableBody = document.getElementById('scheduleTableBody');

async function appendRow(date, total, remaining) {
    // remove placeholder empty-row if present
    const placeholder = scheduleTableBody.querySelector('.empty-row');
    if (placeholder) placeholder.remove();

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${date}</td><td>${total}</td><td>${remaining}</td>`;
    scheduleTableBody.appendChild(tr);
}

async function loadSchedules(){
    // Try to fetch from backend if endpoint exists. If not, keep placeholder.
    try {
        const res = await fetch('../backend/get_schedules.php');
        if (!res.ok) return; // keep empty state
        const data = await res.json();
        const list = data.schedules || data || [];
        if (!Array.isArray(list) || list.length === 0) return;
        // clear placeholder
        scheduleTableBody.innerHTML = '';
        list.forEach(s => {
            // adapt to possible field names
            const date = s.date || s.schedule_date || s.schedule || '';
            const total = s.total_slots || s.total || '';
            const remaining = s.remaining_slots ?? s.remaining ?? '';
            appendRow(date, total, remaining);
        });
    } catch (e) {
        // ignore — backend may not exist yet
        console.warn('Could not load schedules:', e);
    }
}

// intercept form submit
if (scheduleForm) {
    scheduleForm.addEventListener('submit', async function(ev){
        ev.preventDefault();
        const formData = new FormData(scheduleForm);
        const date = formData.get('schedule_date');
        const total = formData.get('total_slots');

        try {
            const resp = await fetch(scheduleForm.action, { method: 'POST', body: formData });
            let result;
            try { result = await resp.json(); } catch(err){ result = null; }
            if (resp.ok && (result === null || result.success === true || result.status === 'ok')) {
                // assume remaining slots == total initially
                appendRow(date, total, total);
                closeScheduleModal();
                scheduleForm.reset();
                alert('Schedule saved');
            } else {
                const msg = result && (result.error || result.msg) ? (result.error || result.msg) : 'Save failed';
                alert('Error saving schedule: ' + msg);
            }
        } catch (e) {
            console.error('Submit error', e);
            alert('Error submitting schedule (see console)');
        }
    });
}

// Load schedules on page ready
window.addEventListener('DOMContentLoaded', () => {
    loadSchedules();
});
</script>

</body>
</html>
