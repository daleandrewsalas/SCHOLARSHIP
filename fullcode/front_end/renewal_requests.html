<?php
session_start();
// Check if admin is logged in
if (!isset($_SESSION["logged_in"]) || $_SESSION["logged_in"] !== true) {
  header("Location: login_admin.php");
  exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EduGrants - Renewal Requests</title>
  <link rel="stylesheet" href="../css/Admin_Dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      padding: 20px;
      border-radius: 8px;
      color: white;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card.total { background: #1e40af; }
    .stat-card.approved { background: #0084ff; }
    .stat-card.pending { background: #60a5fa; }
    
    .stat-number { font-size: 32px; font-weight: 700; }
    .stat-label { font-size: 12px; margin-top: 5px; }

    .renewals-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .renewals-table th {
      background: #315683;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .renewals-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .renewals-table tr:hover {
      background: #f5f5f5;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #d1fae5; color: #065f46; }

    .search-box {
      margin-bottom: 20px;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      width: 100%;
      max-width: 300px;
    }
    
    /* Lighten sidebar icons */
    .sidebar .nav-item img,
    .sidebar .dropdown-btn img {
      filter: brightness(0.8);
      opacity: 0.85;
    }
    
    .sidebar .nav-item:hover img,
    .sidebar .dropdown-btn:hover img {
      filter: brightness(1);
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="../icon/logo.png" class="logo">
        <div class="brand-text">EduGrants</div>
      </div>

      <nav class="nav">
        <a href="admin_dashboard.html" class="nav-item"><img src="../icon/dashboard.png" class="ico"> Dashboard</a>
        <a href="admin_profile.html" class="nav-item"><img src="../icon/admin.png" class="ico"> Admin Profile</a>
        
        <div class="nav-item dropdown">
          <button type="button" class="dropdown-btn">
            <img src="../icon/apply.png" class="ico"> Student Registration
            <span class="arrow">▸</span>
          </button>
          <div class="dropdown-content">
            <a href="system_account.html" class="nav-item">System Account</a> 
            <a href="pending_accounts.html">Pending Applications</a>
          </div>
        </div>

        <a href="set_schedule.html" class="nav-item"><img src="../icon/calendar.png" class="ico"> Set Schedule</a>
        <a href="renewal_requests.html" class="nav-item"><img src="../icon/renewal.png" class="ico"> Renewal Requests</a>
        <a href="logout.php" class="nav-item"><img src="../icon/logout.png" class="ico"> Log out</a>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="user-avatar" id="userAvatar">S</div>
          <div class="user-info">
            <div class="user-name" id="userName">Admin</div>
            <div class="user-role">Administrator</div>
          </div>
        </div>
      </div>
      
    </aside>

    <main class="main">

      <section class="content">
        <h2 class="page-title">RENEWAL REQUESTS</h2>

        <div class="stats-container">
          <div class="stat-card total">
            <div class="stat-number" id="totalRenewals">0</div>
            <div class="stat-label">Total Renewals</div>
          </div>
          <div class="stat-card pending">
            <div class="stat-number" id="pendingRenewals">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card approved">
            <div class="stat-number" id="approvedRenewals">0</div>
            <div class="stat-label">Approved</div>
          </div>
        </div>

        <input type="text" class="search-box" id="searchBox" placeholder="Search by name or email...">

        <table class="renewals-table" id="renewalsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>School Year</th>
              <th>School</th>
              <th>GPA</th>
              <th>Status</th>
              <th>Date Submitted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="renewalsBody">
            <!-- Data populated by JS -->
          </tbody>
        </table>
      </section>

      <footer class="footer">
        © <span id="year"></span> EduGrants — UI Prototype
      </footer>
    </main>
  </div>

  <script>
    document.getElementById("year").innerText = new Date().getFullYear();

    function loadAdminName() {
      fetch("../backend/get_user.php")
        .then(res => {
          if (!res.ok) throw new Error('Status ' + res.status);
          return res.text();
        })
        .then(text => {
          let data = null;
          try {
            data = JSON.parse(text);
          } catch (e) {
            console.error('Failed to parse get_user JSON. Raw response:', text);
            return;
          }
          if (data && data.name) {
            const firstLetter = data.name.charAt(0).toUpperCase();
            
            // Update sidebar
            const userNameEl = document.getElementById("userName");
            const userAvatarEl = document.getElementById("userAvatar");
            
            if (userNameEl) userNameEl.innerText = data.name;
            if (userAvatarEl) userAvatarEl.innerText = firstLetter;
          }
        })
        .catch(err => console.error("Failed to load admin name:", err));
    }

    function loadRenewals() {
      fetch("../backend/get_renewals.php")
        .then(res => res.json())
        .then(data => {
          document.getElementById("totalRenewals").innerText = data.total || 0;
          document.getElementById("pendingRenewals").innerText = data.pending || 0;
          document.getElementById("approvedRenewals").innerText = data.approved || 0;

          const tbody = document.getElementById("renewalsBody");
          tbody.innerHTML = "";

          if (!data.renewals || data.renewals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No renewal requests found</td></tr>';
            return;
          }

            data.renewals.forEach(renewal => {
            const row = document.createElement("tr");
            const fullname = (renewal.firstname + ' ' + renewal.lastname).trim();
            const statusClass = renewal.status === 'approved' ? 'status-approved' : 'status-pending';
            const statusText = renewal.status.charAt(0).toUpperCase() + renewal.status.slice(1);
            
            // Actions: show approve/decline buttons for pending requests
            let actionsHtml = '';
            if (renewal.status === 'pending') {
                actionsHtml = `
                  <button class="btn-approve" data-id="${renewal.id}" style="margin-right:8px; padding:6px 10px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer;">Approve</button>
                  <button class="btn-decline" data-id="${renewal.id}" style="padding:6px 10px; background:#ef4444; color:white; border:none; border-radius:6px; cursor:pointer;">Decline</button>
                `;
            }

            row.innerHTML = `
              <td>${fullname}</td>
              <td>${renewal.email}</td>
              <td>${renewal.school_year}</td>
              <td>${renewal.school}</td>
              <td>${renewal.gpa}</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>${new Date(renewal.created_at).toLocaleDateString()}</td>
              <td>${actionsHtml}</td>
            `;
            tbody.appendChild(row);
          });

          // Attach event listeners for approve/decline buttons
          document.querySelectorAll('.btn-approve').forEach(btn => {
            btn.addEventListener('click', function(){
              const id = this.getAttribute('data-id');
              if (!confirm('Approve this renewal request?')) return;
              fetch('../backend/renewal_action.php', {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: 'action=approve&id=' + encodeURIComponent(id)
              }).then(r=>r.json()).then(j=>{
                if (j.success) loadRenewals(); else alert('Error: '+(j.message||'failed'));
              }).catch(e=>alert('Request failed'));
            });
          });

          document.querySelectorAll('.btn-decline').forEach(btn => {
            btn.addEventListener('click', function(){
              const id = this.getAttribute('data-id');
              if (!confirm('Decline this renewal request?')) return;
              fetch('../backend/renewal_action.php', {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: 'action=decline&id=' + encodeURIComponent(id)
              }).then(r=>r.json()).then(j=>{
                if (j.success) loadRenewals(); else alert('Error: '+(j.message||'failed'));
              }).catch(e=>alert('Request failed'));
            });
          });
        })
        .catch(err => console.error("Failed to load renewals:", err));
    }

    document.getElementById("searchBox").addEventListener("keyup", function() {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll("#renewalsBody tr");
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    });

    loadAdminName();
    loadRenewals();

    // Auto-refresh every 5 seconds
    setInterval(loadRenewals, 5000);

    document.querySelectorAll(".nav-item.dropdown").forEach(dropdownItem => {
      const btn = dropdownItem.querySelector(".dropdown-btn");
      if (btn) {
        btn.addEventListener("click", () => {
          dropdownItem.classList.toggle("active");
        });
      }
    });
  </script>
</body>
</html>
